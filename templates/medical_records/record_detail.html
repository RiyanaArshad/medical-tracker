{% extends 'base.html' %}
{% load widget_tweaks %}

{% block title %}{{ record.diagnosis }} - Medical Records{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <a href="{% url 'medical_record_list' %}" class="btn btn-outline-secondary mb-2">
            <i class="fas fa-arrow-left me-2"></i>Back to Records
        </a>
        <h1>Medical Record Details</h1>
    </div>
    <div>
        {% if user.profile.is_doctor and record.doctor == user or user.profile.is_admin %}
        <a href="{% url 'medical_record_update' record.id %}" class="btn btn-primary">
            <i class="fas fa-edit me-2"></i>Edit Record
        </a>
        {% endif %}
        {% if user.profile.is_doctor or user.profile.is_patient %}
        <a href="{% url 'medical_report_create' record.id %}" class="btn btn-success">
            <i class="fas fa-file-upload me-2"></i>Upload Report
        </a>
        {% endif %}
    </div>
</div>

{% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
{% endif %}

<div class="row">
    <div class="col-md-8">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>Record Information</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-3 fw-bold">Patient:</div>
                    <div class="col-md-9">{{ record.patient.get_full_name|default:record.patient.username }}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3 fw-bold">Doctor:</div>
                    <div class="col-md-9">
                        {% if record.doctor %}
                            Dr. {{ record.doctor.get_full_name|default:record.doctor.username }}
                        {% else %}
                            Not assigned
                        {% endif %}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3 fw-bold">Diagnosis:</div>
                    <div class="col-md-9">{{ record.diagnosis }}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3 fw-bold">Date Created:</div>
                    <div class="col-md-9">{{ record.date_created|date:"F d, Y - h:i A" }}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3 fw-bold">Last Updated:</div>
                    <div class="col-md-9">{{ record.date_updated|date:"F d, Y - h:i A" }}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3 fw-bold">Description:</div>
                    <div class="col-md-9">{{ record.description|linebreaks }}</div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-file-medical me-2"></i>Medical Reports</h5>
                    <span class="badge bg-primary">{{ reports.count }} Reports</span>
                </div>
            </div>
            <div class="card-body">
                {% if reports %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Date</th>
                                <th>Title</th>
                                <th>Type</th>
                                <th>Uploaded By</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for report in reports %}
                            <tr>
                                <td>{{ report.date|date:"M d, Y" }}</td>
                                <td>{{ report.title }}</td>
                                <td>{{ report.report_type }}</td>
                                <td>{{ report.uploaded_by.get_full_name|default:report.uploaded_by.username }}</td>
                                <td>
                                    <a href="{% url 'medical_report_detail' report.id %}" class="btn btn-sm btn-primary">
                                        <i class="fas fa-eye me-1"></i>View
                                    </a>
                                    <a href="{{ report.report_file.url }}" class="btn btn-sm btn-info" target="_blank">
                                        <i class="fas fa-download me-1"></i>Download
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-file-medical-alt fa-4x text-muted mb-3"></i>
                    <p class="lead">No medical reports found for this record.</p>
                    <a href="{% url 'medical_report_create' record.id %}" class="btn btn-primary">
                        <i class="fas fa-file-upload me-2"></i>Upload Report
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Prescriptions related to this medical record -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-pills me-2"></i>Related Prescriptions</h5>
            </div>
            <div class="card-body">
                {% if record.prescriptions.all %}
                <div class="list-group">
                    {% for prescription in record.prescriptions.all %}
                    <a href="{% url 'prescription_detail' prescription.id %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">{{ prescription.medication_name }}</h6>
                            <p class="mb-1 text-muted small">{{ prescription.dosage }} - {{ prescription.get_frequency_display }}</p>
                        </div>
                        <span class="badge {% if prescription.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                            {% if prescription.is_active %}Active{% else %}Inactive{% endif %}
                        </span>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-3">
                    <p class="text-muted">No prescriptions related to this record.</p>
                    {% if user.profile.is_doctor %}
                    <a href="{% url 'prescription_create' %}?medical_record_id={{ record.id }}&patient_id={{ record.patient.id }}" class="btn btn-sm btn-primary">
                        <i class="fas fa-plus-circle me-1"></i>Add Prescription
                    </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Activity Timeline -->
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-history me-2"></i>Timeline</h5>
            </div>
            <div class="card-body">
                <ul class="timeline">
                    <li class="timeline-item">
                        <div class="timeline-marker bg-primary"></div>
                        <div class="timeline-content">
                            <h6 class="mb-1">Record Created</h6>
                            <p class="mb-0 text-muted small">{{ record.date_created|date:"M d, Y - h:i A" }}</p>
                            <p class="mb-0 text-muted small">By: Dr. {{ record.doctor.get_full_name|default:record.doctor.username }}</p>
                        </div>
                    </li>
                    {% if record.date_updated != record.date_created %}
                    <li class="timeline-item">
                        <div class="timeline-marker bg-info"></div>
                        <div class="timeline-content">
                            <h6 class="mb-1">Record Updated</h6>
                            <p class="mb-0 text-muted small">{{ record.date_updated|date:"M d, Y - h:i A" }}</p>
                        </div>
                    </li>
                    {% endif %}
                    {% for report in reports %}
                    <li class="timeline-item">
                        <div class="timeline-marker bg-success"></div>
                        <div class="timeline-content">
                            <h6 class="mb-1">Report Added: {{ report.title }}</h6>
                            <p class="mb-0 text-muted small">{{ report.date_uploaded|date:"M d, Y - h:i A" }}</p>
                            <p class="mb-0 text-muted small">By: {{ report.uploaded_by.get_full_name|default:report.uploaded_by.username }}</p>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

<style>
.timeline {
    list-style-type: none;
    position: relative;
    padding-left: 30px;
    margin: 0;
}

.timeline-item {
    position: relative;
    padding-bottom: 20px;
}

.timeline-item:last-child {
    padding-bottom: 0;
}

.timeline-marker {
    position: absolute;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    left: -25px;
    top: 6px;
}

.timeline:before {
    content: "";
    position: absolute;
    left: -18px;
    top: 6px;
    height: calc(100% - 12px);
    width: 2px;
    background-color: #ddd;
}
</style>
{% endblock %} 